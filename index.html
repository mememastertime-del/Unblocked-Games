<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Astral Employment</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#07070a; --panel:#0f1113; --muted:#bfc7d0; --accent:#0a9dff;
  --card:#161717; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  background: linear-gradient(180deg,#030307 0%, #0b0c0f 100%); color:#eaf2ff; -webkit-font-smoothing:antialiased;
}

/* Password Screen */
#homeScreen{
  height:100vh; display:flex; align-items:center; justify-content:center; padding:1.5rem; gap:.9rem; flex-direction:column;
  text-align:center;
}
#homeScreen h1{ font-size:2.4rem; margin:0; font-weight:800; letter-spacing:0.6px; color:#fff; }
#passwordInput{ width:300px; padding:.72rem 1rem; border-radius:10px; border:none; background:#151515; color:#fff; font-size:1rem; }
#enterBtn{ width:220px; padding:.7rem 1rem; border-radius:10px; border:none; background:var(--accent); color:#fff; font-weight:700; cursor:pointer; }
#enterBtn:active{ transform:translateY(1px); }
#errorMsg{ color:#ff7b7b; height:1.2rem; }

/* Announcement placeholder (public view). Admin edits stored in Firebase. */
#announcementBar{
  margin-top:.6rem; max-width:360px; padding:.65rem .9rem; border-radius:10px; background:rgba(255,255,255,0.02); color:#d6e8ff;
  border:1px solid rgba(255,255,255,0.03); font-size:.95rem;
}

/* Landing / Hero */
#landingScreen{ display:none; height:100vh; align-items:center; justify-content:center; padding:2rem; }
.hero{ max-width:1120px; display:grid; grid-template-columns:1fr 380px; gap:2rem; align-items:center; width:100%; }
.hero-left{ background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); padding:2rem; border-radius:16px; }
.feature-list{ display:flex; flex-direction:column; gap:.45rem; margin-top:.8rem; }
.feature-list span{ display:inline-block; background:var(--glass); padding:.45rem .7rem; border-radius:10px; font-size:.95rem; color:var(--muted); }

/* Header */
header{ display:none; position:sticky; top:0; z-index:40; padding:.9rem 1rem; background:rgba(4,6,10,0.6); backdrop-filter: blur(6px); display:flex; justify-content:space-between; align-items:center; }
#logoBtn{ display:flex; align-items:center; gap:.6rem; cursor:pointer; border:none; background:transparent; padding:0; }
#logoSVG{ width:36px; height:36px; display:block; }
#categoryBar{ display:flex; gap:.5rem; overflow-x:auto; padding:.2rem 0; -webkit-overflow-scrolling:touch; }
.cat-btn{ display:flex; align-items:center; gap:.5rem; padding:.45rem .7rem; border-radius:999px; background:transparent; border:1px solid transparent; color:var(--muted); cursor:pointer; font-weight:600; white-space:nowrap; }
.cat-btn.active{ background:linear-gradient(90deg, rgba(10,157,255,0.12), rgba(10,157,255,0.06)); color:#fff; border-color:rgba(10,157,255,0.08); box-shadow:0 8px 24px rgba(10,157,255,0.04); }
#searchBox{ padding:.6rem .9rem; width:300px; border-radius:12px; border:none; background:#111217; color:#fff; }

/* App area */
#app{ max-width:1180px; margin:0 auto; padding:1.1rem; }

/* Featured row & Recently Played row */
.featured-row{ display:flex; gap:1rem; margin-bottom:1rem; align-items:stretch; }
.featured-card{ flex:1; min-height:130px; border-radius:12px; background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); padding:1rem; display:flex; gap:1rem; align-items:center; }
.recent-row{ display:flex; gap:1rem; margin-bottom:1rem; align-items:center; }

/* Grid list */
.game-list{ display:grid; grid-template-columns: repeat(auto-fill, minmax(210px,1fr)); gap:1rem; }
.game-card{ background:var(--card); border-radius:12px; overflow:hidden; position:relative; cursor:pointer; transition:transform .18s ease, box-shadow .18s ease; box-shadow:0 10px 34px rgba(0,0,0,.6); height:260px; display:flex; flex-direction:column; }
.game-card:hover{ transform:translateY(-6px); box-shadow:0 20px 80px rgba(0,0,0,.7); }
.thumbnail{ width:100%; height:120px; object-fit:cover; display:block; }
.card-body{ padding:.8rem; display:flex; flex-direction:column; gap:.5rem; flex:1; }
.title{ font-weight:700; font-size:1rem; color:#fff; line-height:1.1; height:2.4em; overflow:hidden; }
.tags{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:auto; }
.tag{ font-size:.75rem; padding:.25rem .45rem; border-radius:8px; background:rgba(255,255,255,0.03); color:var(--muted); border:1px solid rgba(255,255,255,0.02); }

/* Hover overlay details */
.hover-details{ position:absolute; inset:0; background:linear-gradient(180deg, rgba(5,5,5,0.0), rgba(2,2,2,0.9)); opacity:0; transform:translateY(6px); transition:all .22s ease; display:flex; flex-direction:column; justify-content:flex-end; padding:1rem; }
.game-card:hover .hover-details{ opacity:1; transform:translateY(0); }
.hover-desc{ color:var(--muted); font-size:.92rem; margin-bottom:.6rem; max-height:3.2em; overflow:hidden; }
.hover-actions{ display:flex; gap:.5rem; align-items:center; }
.play-btn{ padding:.5rem .8rem; border-radius:8px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:700; }

/* No results */
.no-results{ text-align:center; padding:3rem 1rem; color:var(--muted); font-size:1.05rem; }

/* Chat area */
#chatContainer{ display:flex; flex-direction:column; height:70vh; gap:.5rem; }
#chatMessages{ flex:1; overflow-y:auto; background:#0f0f10; padding:.8rem; border-radius:8px; }
#chatInput{ flex:1; padding:.6rem .8rem; border-radius:8px; border:none; background:#151515; color:#fff; }
#chatSend{ padding:.55rem .8rem; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer; }

/* Footer */
footer{ padding:1rem; text-align:center; color:var(--muted); font-size:.9rem; }

/* Admin modal */
.modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:9999; }
.modal{ background:linear-gradient(180deg, #0f1113, #121317); padding:1rem; border-radius:12px; width:380px; max-width:90%; box-shadow:0 30px 80px rgba(0,0,0,0.7); }
.modal h3{ margin:0 0 .6rem 0; color:#fff; }
.input{ width:100%; padding:.6rem .8rem; border-radius:8px; border:none; background:#0c0d0f; color:#fff; margin-bottom:.6rem; }
.btn{ padding:.5rem .8rem; border-radius:8px; border:none; cursor:pointer; }
.btn-primary{ background:var(--accent); color:#fff; font-weight:700; }
.btn-ghost{ border:1px solid rgba(255,255,255,0.04); color:var(--muted); background:transparent; }

/* Responsive tweaks */
@media (max-width:900px){
  .hero{ grid-template-columns:1fr; padding:1rem; }
  #searchBox{ width:140px; }
  .game-card{ height:280px; }
}
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="homeScreen" role="main" aria-labelledby="siteTitle">
  <h1 id="siteTitle">Astral Employment</h1>
  <div id="announcementBar">Loading announcement...</div>
  <input id="passwordInput" type="password" autocomplete="off" placeholder="Enter access code" aria-label="access code" />
  <button id="enterBtn">Enter</button>
  <div id="errorMsg" aria-live="polite"></div>
</div>

<!-- LANDING / HERO -->
<div id="landingScreen" style="display:none">
  <div class="hero">
    <div class="hero-left">
      <h1>Welcome to Astral Employment</h1>
      <div class="feature-list">
        <span>Game card hover details</span>
        <span>Featured games sections</span>
        <span>Smarter search with highlights</span>
        <span>Emoji category icons</span>
        <span>Animation polish & tags</span>
      </div>
      <div style="margin-top:1rem">
        <button id="enterHubBtn" class="btn btn-primary">Enter Hub</button>
      </div>
    </div>
    <div class="hero-right" style="display:flex;flex-direction:column;gap:.8rem;align-items:center;justify-content:center;">
      <button id="viewChat" class="btn btn-ghost">Open Chat</button>
    </div>
  </div>
</div>

<!-- MAIN HEADER (hidden until login) -->
<header id="mainHeader" style="display:none">
  <button id="logoBtn" title="Astral Employment (logo)">
    <!-- C2: Icon only logo (animated SVG nebula star) -->
    <svg id="logoSVG" viewBox="0 0 64 64" aria-hidden="true" role="img">
      <defs>
        <radialGradient id="g1" cx="30%" cy="30%">
          <stop offset="0%" stop-color="#9be3ff" stop-opacity="1"/>
          <stop offset="60%" stop-color="#6b68ff" stop-opacity=".6"/>
          <stop offset="100%" stop-color="#2a1b5f" stop-opacity="0"/>
        </radialGradient>
      </defs>
      <circle cx="32" cy="32" r="18" fill="url(#g1)"/>
      <g transform="translate(32,32)">
        <path d="M0-12 L2 -4 L10 -2 L2 1 L0 10 L-2 1 L-10 -2 L-2 -4 Z" fill="#fff" opacity=".9">
          <animateTransform attributeName="transform" type="rotate" from="0" to="360" dur="12s" repeatCount="indefinite"/>
        </path>
      </g>
    </svg>
  </button>

  <div style="display:flex;align-items:center;gap:1rem;">
    <div id="categoryBar" role="tablist" aria-label="Categories"></div>
    <input id="searchBox" type="search" placeholder="Search games..." aria-label="search games" />
  </div>
</header>

<!-- APP -->
<div id="app"></div>

<!-- Footer with Admin Login -->
<footer>
  <a href="#" id="otherLinks" style="color:var(--muted);margin-right:1rem">Other Websites</a>
  <a href="#" id="adminLoginLink" style="color:var(--muted);margin-left:1rem">Admin Login</a>
</footer>

<!-- Firebase (kept for announcements & chat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ======================
   Configuration & State
   ====================== */

/*
  Password handling:
  - No plaintext passwords are present in the file.
  - The SHA-256 hex hashes below correspond to:
      main access password: "DIHALB"  -> store only the hash
      admin password: "th!nBlu3"     -> store only the hash
  - We compare the SHA-256 of the entered string to these stored hashes.
*/
const HASH_MAIN = "875b0cbe469a54473cd975c129b87fadaa6d15d6dacf0634ea24b70e0b58c04b";
const HASH_ADMIN = "23c28e809cef8751da4a6393e9cb183b8d969f77ab0ade39e6b282e19e40378f";

/* Games JSON */
const GAMES_JSON_URL = "https://raw.githubusercontent.com/swarmintelli/Unblocked-Games-CDN/main/games.json";

/* Emoji map for categories */
const emojiMap = {
  "all":"‚ú®","action":"üéØ","adventure":"üó∫Ô∏è","puzzle":"üß©","racing":"üöó",
  "multiplayer":"ü§ù","strategy":"‚ôüÔ∏è","sports":"üèÖ","classics":"üéÆ"
};

/* Firebase config (unchanged) */
const firebaseConfig = {
  apiKey: "AIzaSyAyHooV5floB-DdLAFdczfgEuDPEWtfGgA",
  authDomain: "chatroom-4e6e4.firebaseapp.com",
  databaseURL: "https://chatroom-4e6e4-default-rtdb.firebaseio.com",
  projectId: "chatroom-4e6e4",
  storageBucket: "chatroom-4e6e4.firebasestorage.app",
  messagingSenderId: "352956674536",
  appId: "1:352956674536:web:1942c8198827e8f5f6b45d"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

/* Runtime state */
let gamesCache = [];
let categories = ["all","action","adventure","puzzle","racing","multiplayer","strategy","sports","classics"];
let activeCategory = "all";
let adminAuthenticated = false;

/* UI refs */
const homeScreen = document.getElementById("homeScreen");
const landingScreen = document.getElementById("landingScreen");
const mainHeader = document.getElementById("mainHeader");
const app = document.getElementById("app");
const searchBox = document.getElementById("searchBox");
const categoryBar = document.getElementById("categoryBar");
const announcementBar = document.getElementById("announcementBar");

/* =====================
   Utility: SHA-256 hex
   ===================== */
async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const digest = await crypto.subtle.digest("SHA-256", enc);
  const bytes = new Uint8Array(digest);
  return Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
}

/* =====================
   Initial: announcement listener
   ===================== */
const ANN_PATH = "announcement/latest";
function listenAnnouncement(){
  database.ref(ANN_PATH).on("value", snap=>{
    const val = snap.val();
    if(!val) {
      announcementBar.textContent = "No announcements right now.";
      return;
    }
    // val expected: { text: "...", updatedAt: 169xxx }
    const txt = val.text || "";
    const ts = val.updatedAt ? new Date(val.updatedAt).toLocaleString() : "";
    announcementBar.innerHTML = `<div style="font-weight:700;color:#fff;margin-bottom:.25rem">Announcement</div><div>${escapeHtml(txt)}</div><div style="margin-top:.45rem;font-size:.78rem;color:var(--muted)">Last updated: ${escapeHtml(ts)}</div>`;
  }, err=> {
    announcementBar.textContent = "Announcements unavailable.";
    console.error("announce listen error", err);
  });
}
listenAnnouncement();

/* =====================
   Password flow (main access)
   ===================== */
const passwordInput = document.getElementById("passwordInput");
const enterBtn = document.getElementById("enterBtn");
const errorMsg = document.getElementById("errorMsg");

enterBtn.addEventListener("click", async ()=>{
  errorMsg.textContent = "";
  const v = (passwordInput.value || "").trim();
  if(!v) { errorMsg.textContent = "Enter access code"; return; }
  const h = await sha256Hex(v);
  // compare to stored hash
  if(h === HASH_MAIN){
    // clear sensitive input immediately
    passwordInput.value = "";
    // show landing hero
    homeScreen.style.display = "none";
    landingScreen.style.display = "flex";
  } else {
    errorMsg.textContent = "Incorrect access code";
    passwordInput.animate([{transform:'translateX(0)'},{transform:'translateX(-6px)'},{transform:'translateX(6px)'},{transform:'translateX(0)'}],{duration:240});
    // clear the entered value
    passwordInput.value = "";
  }
});

// allow enter key
passwordInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") enterBtn.click(); });

/* =====================
   Landing -> Enter Hub
   ===================== */
document.getElementById("enterHubBtn").addEventListener("click", async ()=>{
  landingScreen.style.display = "none";
  mainHeader.style.display = "flex";
  await loadGames();
  showGameList(gamesCache);
});

/* quick chat preview */
document.getElementById("viewChat").addEventListener("click", ()=>{
  landingScreen.style.display = "none";
  mainHeader.style.display = "flex";
  showChat();
});

/* =====================
   Load games JSON
   ===================== */
async function loadGames(){
  try{
    const r = await fetch(GAMES_JSON_URL);
    const data = await r.json();
    gamesCache = data || [];
    // add categories from JSON if missing
    gamesCache.forEach(g=>{
      if(Array.isArray(g.tags)) g.tags.forEach(t=>{
        const key = String(t).toLowerCase();
        if(key && !categories.includes(key)) categories.push(key);
      });
    });
    buildCategoryBar();
    return gamesCache;
  }catch(e){
    console.error("loadGames error", e);
    gamesCache = [];
    buildCategoryBar();
    return [];
  }
}

/* =====================
   Category bar
   ===================== */
function buildCategoryBar(){
  categoryBar.innerHTML = "";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.className = "cat-btn" + (cat === activeCategory ? " active" : "");
    const label = cat === "all" ? "All" : cat.charAt(0).toUpperCase() + cat.slice(1);
    btn.innerHTML = `<span style="font-size:1rem">${emojiMap[cat] || "üîπ"}</span><span style="margin-left:.4rem">${label}</span>`;
    btn.onclick = ()=>{ activeCategory = cat; document.querySelectorAll(".cat-btn").forEach(x=>x.classList.remove("active")); btn.classList.add("active"); filterGames(); };
    categoryBar.appendChild(btn);
  });
}

/* =====================
   Search + highlight helpers
   ===================== */
function escapeHtml(s){ return (s||"").toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function highlightMatch(text, q){
  if(!q) return escapeHtml(text);
  const idx = text.toLowerCase().indexOf(q.toLowerCase());
  if(idx===-1) return escapeHtml(text);
  const before = escapeHtml(text.slice(0, idx));
  const match = escapeHtml(text.slice(idx, idx+q.length));
  const after = escapeHtml(text.slice(idx+q.length));
  return `${before}<mark style="background:rgba(10,157,255,0.18);padding:.05rem .12rem;border-radius:4px;color:#fff">${match}</mark>${after}`;
}

/* =====================
   Recently Played utilities (localStorage)
   ===================== */
const RP_KEY = "astral_recently_played";
function pushRecentlyPlayed(game){
  try{
    const arr = JSON.parse(localStorage.getItem(RP_KEY) || "[]");
    // store minimal info
    const entry = { id: game.id || game.name || Math.random().toString(36).slice(2,9), name: game.name || "Untitled", url: game.url || game.game_url || game.iframe || "", thumb: game.game_image_icon || game.thumbnail || "" , ts: Date.now() };
    // remove existing same id
    const filtered = arr.filter(x=>x.id !== entry.id);
    filtered.unshift(entry);
    const sliced = filtered.slice(0,6);
    localStorage.setItem(RP_KEY, JSON.stringify(sliced));
    return sliced;
  }catch(e){ console.error("rp push", e); return []; }
}
function getRecentlyPlayed(){ try{ return JSON.parse(localStorage.getItem(RP_KEY) || "[]"); }catch(e){ return []; } }

/* =====================
   Render: Featured, Recently, Grid
   ===================== */
function showGameList(games){
  app.innerHTML = "";

  // Featured
  const featured = (games || []).filter(g => g.featured).slice(0,3);
  if(featured.length){
    const fr = document.createElement("div"); fr.className = "featured-row";
    featured.forEach(f=>{
      const fc = document.createElement("div"); fc.className = "featured-card";
      const img = document.createElement("img"); img.src = f.game_image_icon || f.thumbnail || ""; img.alt = f.name || ""; img.style.width="140px"; img.style.height="90px"; img.style.objectFit="cover"; img.style.borderRadius="8px";
      const meta = document.createElement("div");
      const t = document.createElement("div"); t.style.fontWeight=700; t.style.color="#fff"; t.textContent = f.name || "Untitled";
      const d = document.createElement("div"); d.style.color="var(--muted)"; d.style.marginTop=".45rem"; d.textContent = f.description || "";
      const play = document.createElement("button"); play.className="btn btn-primary"; play.style.marginTop="8px"; play.textContent="Play"; play.onclick = ()=> showGamePage(f);
      meta.appendChild(t); meta.appendChild(d); meta.appendChild(play);
      fc.appendChild(img); fc.appendChild(meta); fr.appendChild(fc);
    });
    app.appendChild(fr);
  }

  // Recently played row (RP-A)
  const rp = getRecentlyPlayed();
  if(rp && rp.length){
    const rr = document.createElement("div"); rr.className = "recent-row";
    rr.style.marginBottom = "12px";
    const label = document.createElement("div"); label.style.fontWeight=700; label.style.marginRight="1rem"; label.style.color="#fff"; label.textContent="Recently Played";
    rr.appendChild(label);
    rp.forEach(item=>{
      const c = document.createElement("div"); c.style.display="flex"; c.style.flexDirection="column"; c.style.alignItems="center"; c.style.width="140px";
      const img = document.createElement("img"); img.src = item.thumb || ""; img.alt = item.name; img.style.width="120px"; img.style.height="72px"; img.style.objectFit="cover"; img.style.borderRadius="8px";
      const nm = document.createElement("div"); nm.style.marginTop="6px"; nm.style.fontSize=".9rem"; nm.style.color="var(--muted)"; nm.textContent = item.name;
      c.appendChild(img); c.appendChild(nm);
      c.onclick = ()=> { // try opening via iframe page
        const game = gamesCache.find(g => (g.name && g.name === item.name) || (g.id && g.id === item.id));
        if(game) showGamePage(game);
      }
      rr.appendChild(c);
    });
    app.appendChild(rr);
  }

  // Grid
  const q = (searchBox.value || "").trim();
  const filtered = (games || []).filter(g=>{
    const name = (g.name||"").toLowerCase();
    const desc = (g.description||"").toLowerCase();
    const tags = (g.tags || []).map(t=>String(t).toLowerCase());
    const matchesQuery = !q || name.includes(q.toLowerCase()) || desc.includes(q.toLowerCase()) || tags.some(t=>t.includes(q.toLowerCase()));
    const matchesCat = activeCategory === "all" || tags.includes(activeCategory);
    return matchesQuery && matchesCat;
  });

  if(filtered.length === 0){
    const no = document.createElement("div"); no.className = "no-results"; no.textContent = `No results found${q?(" for \""+q+"\""):''}.`;
    app.appendChild(no);
    return;
  }

  const list = document.createElement("div"); list.className = "game-list";
  filtered.forEach(game=>{
    const card = document.createElement("div"); card.className = "game-card";
    // thumbnail
    const thumb = document.createElement("img"); thumb.className = "thumbnail"; thumb.loading = "lazy"; thumb.src = game.game_image_icon || game.thumbnail || ""; thumb.alt = game.name || "";
    // body
    const body = document.createElement("div"); body.className = "card-body";
    const title = document.createElement("div"); title.className = "title"; title.innerHTML = highlightMatch(game.name || "Untitled", q);
    const tagsWrap = document.createElement("div"); tagsWrap.className = "tags";
    const tagsList = Array.isArray(game.tags) ? game.tags.slice(0,4) : [];
    tagsList.forEach(t=>{
      const tg = document.createElement("div"); tg.className = "tag"; tg.textContent = t; tagsWrap.appendChild(tg);
    });
    // hover
    const hover = document.createElement("div"); hover.className = "hover-details";
    const desc = document.createElement("div"); desc.className = "hover-desc"; desc.textContent = game.description || "No description available.";
    const actions = document.createElement("div"); actions.className = "hover-actions";
    const playBtn = document.createElement("button"); playBtn.className = "play-btn"; playBtn.textContent = "Play";
    playBtn.addEventListener("click", (ev)=>{ ev.stopPropagation(); showGamePage(game); });
    actions.appendChild(playBtn);
    hover.appendChild(desc); hover.appendChild(actions);

    body.appendChild(title); body.appendChild(tagsWrap);
    card.appendChild(thumb); card.appendChild(body); card.appendChild(hover);

    card.addEventListener("click", ()=> showGamePage(game) );
    list.appendChild(card);
  });

  app.appendChild(list);
}

/* =====================
   Game page (iframe) and track recently played
   ===================== */
function showGamePage(game){
  app.innerHTML = "";
  const container = document.createElement("div"); container.style.padding = "0 0 1rem 0";
  const back = document.createElement("span"); back.className = "back-link"; back.textContent = "‚Üê Back to games"; back.onclick = ()=> showGameList(gamesCache);
  container.appendChild(back);

  const iframe = document.createElement("iframe");
  iframe.style.width = "100%"; iframe.style.height = "78vh"; iframe.style.border = "none"; iframe.style.borderRadius = "10px"; iframe.style.background = "#000";

  if(game.iframe) iframe.srcdoc = game.iframe;
  else if(game.url) iframe.src = game.url;
  else if(game.game_url) iframe.src = game.game_url;
  else iframe.srcdoc = `<body style="background:#000;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh;margin:0"><div style="text-align:center"><h2>${escapeHtml(game.name||"Game")}</h2><p style="color:#bbb">No playable iframe URL provided.</p></div></body>`;

  container.appendChild(iframe);
  app.appendChild(container);

  // push recently played
  pushRecentlyPlayed(game);
}

/* =====================
   Search / filter wiring
   ===================== */
searchBox.addEventListener("input", debounce(()=> filterGames(), 160));
function filterGames(){ showGameList(gamesCache); }

/* =====================
   Chatroom UI
   ===================== */
function showChat(){
  app.innerHTML = `<span class="back-link" onclick="showGameList(gamesCache)">‚Üê Back to games</span>
    <div id="chatContainer">
      <div id="chatMessages"></div>
      <div style="display:flex;gap:.4rem;margin-top:.6rem;">
        <input id="chatInput" placeholder="Message..." style="flex:1;padding:.6rem;border-radius:8px;border:none;background:#0b0c0e;color:#fff">
        <button id="chatSend" class="btn btn-primary">Send</button>
      </div>
    </div>`;
  const messages = document.getElementById("chatMessages");
  database.ref("chat").off();
  database.ref("chat").on("child_added", snap=>{
    const d = document.createElement("div");
    d.textContent = snap.val();
    d.style.margin = ".3rem 0";
    d.style.background = "rgba(255,255,255,0.02)";
    d.style.padding = ".45rem .6rem";
    d.style.borderRadius = "6px";
    messages.appendChild(d);
    messages.scrollTop = messages.scrollHeight;
  });
  document.getElementById("chatSend").onclick = ()=>{
    const v = document.getElementById("chatInput").value.trim();
    if(!v) return;
    database.ref("chat").push(v);
    document.getElementById("chatInput").value = "";
  };
}

/* =====================
   Admin Login flow (modal)
   ===================== */
const adminLoginLink = document.getElementById("adminLoginLink");
adminLoginLink.addEventListener("click", (e)=>{ e.preventDefault(); openAdminModal(); });

function openAdminModal(){
  const backdrop = document.createElement("div"); backdrop.className = "modal-backdrop";
  const modal = document.createElement("div"); modal.className = "modal";
  modal.innerHTML = `
    <h3>Admin Login</h3>
    <input id="admPwd" class="input" type="password" placeholder="Admin password" />
    <div style="display:flex;gap:.5rem;justify-content:flex-end;">
      <button id="admCancel" class="btn btn-ghost">Cancel</button>
      <button id="admLogin" class="btn btn-primary">Login</button>
    </div>
    <div id="admMsg" style="margin-top:.6rem;color:var(--muted);font-size:.9rem"></div>
  `;
  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);
  document.getElementById("admCancel").onclick = ()=> backdrop.remove();
  document.getElementById("admLogin").onclick = async ()=>{
    const v = document.getElementById("admPwd").value || "";
    const admMsg = document.getElementById("admMsg");
    admMsg.textContent = "";
    const h = await sha256Hex(v);
    if(h === HASH_ADMIN){
      // success
      adminAuthenticated = true;
      sessionStorage.setItem("astral_admin", "1");
      backdrop.remove();
      openAdminPanel();
    } else {
      admMsg.textContent = "Invalid admin password";
      document.getElementById("admPwd").value = "";
    }
  };
}

/* =====================
   Admin Panel (edit announcement)
   ===================== */
function openAdminPanel(){
  // render admin UI in app area (toggle)
  app.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
      <div style="font-weight:800;font-size:1.2rem;color:#fff">Admin Panel</div>
      <div><button id="admLogout" class="btn btn-ghost">Logout</button></div>
    </div>
    <div style="display:grid;gap:.6rem;">
      <label style="color:var(--muted)">Edit announcement (visible to all users):</label>
      <textarea id="admAnnouncement" style="min-height:120px;padding:.7rem;border-radius:8px;background:#0b0c0e;border:none;color:#fff"></textarea>
      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
        <button id="admCancel2" class="btn btn-ghost">Cancel</button>
        <button id="admSave" class="btn btn-primary">Save Announcement</button>
      </div>
      <div style="margin-top:.6rem;color:var(--muted);font-size:.9rem" id="admStatus"></div>
    </div>`;
  // load current announcement
  database.ref(ANN_PATH).once("value").then(snap=>{
    const v = snap.val(); document.getElementById("admAnnouncement").value = v && v.text ? v.text : "";
  }).catch(e=> console.error("adm load", e));
  document.getElementById("admCancel2").onclick = ()=> showGameList(gamesCache);
  document.getElementById("admLogout").onclick = ()=>{ adminAuthenticated = false; sessionStorage.removeItem("astral_admin"); showGameList(gamesCache); };
  document.getElementById("admSave").onclick = async ()=>{
    const txt = document.getElementById("admAnnouncement").value || "";
    document.getElementById("admStatus").textContent = "Saving...";
    const payload = { text: txt, updatedAt: Date.now() };
    try{
      await database.ref(ANN_PATH).set(payload);
      document.getElementById("admStatus").textContent = "Saved.";
      // announce saved; announcementBar listener will update automatically
    }catch(e){
      console.error("save ann", e); document.getElementById("admStatus").textContent = "Save failed.";
    }
  };
}

/* On page load, restore admin auth from session if present */
if(sessionStorage.getItem("astral_admin")){ adminAuthenticated = true; }

/* =====================
   Other Websites (admin only edit removed)
   ===================== */
document.getElementById("otherLinks").addEventListener("click", (e)=>{ e.preventDefault(); showOtherWebsites(); });
function showOtherWebsites(){
  app.innerHTML = `<span class="back-link" onclick="showGameList(gamesCache)">‚Üê Back to games</span>
    <div id="otherWebsitesList" style="margin-top:8px;"></div>`;
  const links = [
    "https://example1.com",
    "https://example2.com"
  ];
  const list = document.getElementById("otherWebsitesList");
  links.forEach(u=>{
    const a = document.createElement("a"); a.href = u; a.target = "_blank"; a.textContent = u; a.style.display="block"; a.style.marginTop=".35rem"; a.style.color="var(--muted)";
    list.appendChild(a);
  });
}

/* =====================
   Utilities: debounce
   ===================== */
function debounce(fn, wait){ let t; return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), wait); }; }

/* =====================
   Startup: build categories and listeners
   ===================== */
function buildCategoryBar(){
  categoryBar.innerHTML = "";
  categories.forEach(cat=>{
    const btn = document.createElement("button");
    btn.className = "cat-btn" + (cat === activeCategory ? " active" : "");
    const label = cat === "all" ? "All" : cat.charAt(0).toUpperCase() + cat.slice(1);
    btn.innerHTML = `<span style="font-size:1rem">${emojiMap[cat] || "üîπ"}</span><span style="margin-left:.4rem">${label}</span>`;
    btn.onclick = ()=>{ activeCategory = cat; document.querySelectorAll(".cat-btn").forEach(x=>x.classList.remove("active")); btn.classList.add("active"); filterGames(); };
    categoryBar.appendChild(btn);
  });
}
buildCategoryBar();
searchBox.addEventListener("input", debounce(()=> filterGames(), 180));

/* =====================
   Helper: filterGames shorthand
   ===================== */
function filterGames(){ showGameList(gamesCache); }

/* =====================
   On load: ensure announcement and minimal UI text
   ===================== */
(function init(){
  // announcementBar placeholder is already present; announce listener attached earlier
  announcementBar.textContent = "Loading announcements...";
})();

/* =====================
   Expose some functions to global for inline handlers (back links)
   ===================== */
window.showGameList = ()=> showGameList(gamesCache);
window.showChat = showChat;

/* =====================
   Note: no passwords are printed anywhere in console.
   ===================== */
</script>
</body>
</html>
